---
title: 실시간 이미지 최적화 시스템
tags: [Lambda@Edge, CloudFront, S3, WebP, AVIF]
github: https://github.com/banggeunho
thumbnail: images/thumbnail.svg
date: 2024-03-01
---

## 개요
에브리타임 혜택탭 출시로 트래픽 30% 증가 상황에서 Lambda@Edge 기반 On-demand 이미지 처리 시스템을 구축하여 비용을 68% 절감하고 페이지 로딩 속도를 50% 개선했습니다.

## 문제 상황

**에브리타임 혜택탭 출시 배경:**

에브리타임은 대학생 커뮤니티 앱으로, 커머스 서비스를 앱 내 전용 '혜택탭'으로 노출하게 되었습니다. 거의 모든 페이지에 배너와 상품 이미지가 존재하여 출시 후 트래픽이 30% 급증했고, CloudFront 데이터 전송 비용이 피크 월 90만 원에 도달했습니다.

**기존 시스템의 문제:**

- **원본 이미지 서빙:** 고해상도 원본 파일을 그대로 전송 (불필요한 대역폭 낭비)
- **크기 제한 불일치:** 서비스별로 요구하는 이미지 사이즈가 다름에도 통일된 처리 로직 부재
- **비효율적 처리:** 어드민 업로드 시점에 크기 제한을 두거나, 클라이언트(앱)에서 이미지를 잘라서 표시 (UX 저하)
- **포맷 최적화 부재:** WebP, AVIF 등 차세대 포맷 미지원

## 주요 성과

- CloudFront 전송량: 419GB → 132GB (68% 감소)
- 이미지 용량: 평균 85~90% 감소
- 월 비용: 90만원 → 28만원 (68% 절감)
- 페이지 로딩: 1.2초 → 0.6초 (50% 개선)

## 시스템 아키텍처
```mermaid
graph TB
    A[브라우저] -->|?w&h&f&q| B[CloudFront]
    B --> C[CloudFront Functions]
    C -->|검증 OK| D[Lambda@Edge]
    C -.검증 실패.-> E[403]
    D -->|원본 요청| F[S3]
    D -->|리사이징<br/>포맷 변환| B
    B -->|캐싱| A
```

## 주요 기능

**CloudFront Functions (어뷰징 방지):**

- **포맷 검증:** 허용된 이미지 포맷만 처리 (webp, avif, jpg, png)
- **크기 정규화:** 요청 크기를 100px 단위로 반올림하여 캐시 효율 극대화 (예: 387px → 400px)
- **범위 제한:** 허용 가능한 이미지 크기 범위 검증 (50px ~ 2000px)
- **악의적 요청 차단:** 비정상적인 쿼리 파라미터 조합 차단으로 비용 폭증 방지
- **성능 최적화:** Viewer Request 단계에서 경량 JavaScript 실행 (Lambda@Edge 호출 전 사전 필터링)

**Lambda@Edge (이미지 처리):**

- **리사이징:** Sharp 라이브러리 기반 고성능 이미지 리사이징
- **포맷 변환:** WebP, AVIF 등 차세대 압축 포맷 지원 (브라우저 호환성 자동 처리)
- **품질 조정:** 기본 80% 품질로 시각적 품질과 용량 최적 밸런스 유지
- **원본 보존:** S3에 원본 이미지 유지, 변환된 이미지는 CloudFront 캐시에만 저장

**프론트엔드:**
```html
<picture>
  <source srcset="?w=400&f=avif" type="image/avif">
  <source srcset="?w=400&f=webp" type="image/webp">
  <img src="?w=400&f=jpg" alt="상품">
</picture>
```

## 기술적 도전과 해결

**도전 1: Lambda@Edge 타임아웃**

- **문제:** 대용량 이미지 처리 시 Lambda@Edge 타임아웃 발생
- **해결:** Sharp 라이브러리 최적화 설정, 메모리 1024MB 할당으로 처리 속도 향상

**도전 2: 비용 폭증 우려**

- **문제:** 악의적 사용자가 다양한 크기 조합을 요청하면 Lambda 호출 비용 폭증 가능
- **해결:** CloudFront Functions 사전 검증으로 비정상 요청 차단, 캐시 효율 극대화

**도전 3: 캐시 히트율 개선**

- **문제:** 초기 캐시 히트율 65%로 Lambda 호출이 빈번하여 비용 및 응답 속도 저하
- **해결:** 캐시 키 정규화 (100px 단위), 인기 크기 우선 캐싱 전략으로 히트율 85%까지 개선

## 기술 스택

- Lambda@Edge, CloudFront Functions, S3
- Sharp (Node.js), TypeScript

## 배운 점

- 엣지 컴퓨팅 아키텍처 설계 경험 (CDN 레벨에서의 동적 처리)
- 차세대 이미지 포맷 활용 (WebP, AVIF) 및 브라우저 호환성 처리
- AWS 비용 최적화 전략 (캐시 효율, 어뷰징 방지)
